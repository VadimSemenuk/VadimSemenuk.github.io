<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>App redirect</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" integrity="sha512-CNgIRecGo7nphbeZ04Sc13ka07paqdeTu0WR1IM4kNcpmBAUSHSQX0FslNhTDadL4O5SAGapGt4FodqL8My0mA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
      * {
        box-sizing: border-box;
        padding: 0;
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        font-optical-sizing: auto;
        font-weight: 400;
        font-style: normal;
        font-variation-settings: "wdth" 100;
      }

      body {
        background-color: #eeeeee;
        color: #222222;
      }

      .hidden {
        display: none !important;
      }

      .qr-code-container {
        height: 100vh;
        width: 100vw;
        padding: 30px;
        display: flex;
        gap: 40px;
        align-items: center;
        justify-content: center;
      }

      .qr-code-container .title {
        font-size: 40px;
        font-weight: 600;
        max-width: 500px;
      }

      .qr-code-wrapper {
        padding: 20px;
        background-color: white;
        border-radius: 10px;
      }

      #qrcode {
        width: 300px;
        height: 300px;
      }

      .mobile-loader {
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        /*justify-content: center;*/
        gap: 20px;
        padding: 30px;
      }

      .mobile-loader img {
        width: 100px;
        height: 100px;
        margin-top: 50px;
        border-radius: 9999px;
      }

      .mobile-loader .title {
        font-size: 24px;
        text-align: center;
      }

      /*region progress bar*/
      .progress-container {
        width: 100%;
        margin-top: 10px;
      }

      .progress-container .progress-bar {
        width: 100%;
        height: 8px;
        background-color: #ddd;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 10px;
      }

      .progress-container .progress-fill {
        height: 100%;
        background-color: #607d8b;
        transition: width 0.3s ease;
        border-radius: 4px;
      }
      /*endregion*/
    </style>
</head>

<body>

<div class="container">
    <div class="hidden qr-code-container">
        <div class="qr-code-wrapper">
            <div id="qrcode"></div>
        </div>
        <span class="title">Для оплаты отсканируйте QR-код с помощью камеры телефона и перейдите по ссылке</span>
    </div>

    <div class="hidden mobile-loader">
        <img class="bank-icon" />

        <span class="title">Открываем приложение</span>

        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    const DeviceDetector = {
        isAppleMobile() {
            return /iPhone|iPad|iPod/i.test(navigator.userAgent);
        },

        isAndroidMobile() {
            return /Android/i.test(navigator.userAgent);
        },

        isMobile() {
            return DeviceDetector.isAppleMobile() || DeviceDetector.isAndroidMobile()
        }
    }

    class LinksHelper {
        getLinks(bank, amount, to, countryCode, targetBank) {
            switch (bank) {
                case 'sber': {
                    return this.getSberLinks(amount, to)
                }
                case 'sber_international': {
                    return this.getSberInternationalLinks(amount, to)
                }
                case 'tbank': {
                    return this.getTBankLinks(amount, to, false)
                }
                case 'tbank_international': {
                    return this.getTBankLinks(amount, to, true)
                }
                case 'vtb': {
                    return this.getVtbLinks(amount, to)
                }
                case 'vtb_international': {
                    return this.getVtbInternationalLinks(amount, to, countryCode, targetBank)
                }
                case 'alfabank': {
                    return this.getAlfabankLinks(amount, to)
                }
                case 'alfabank_international': {
                    return this.getAlfabankInternationalLinks(amount, to, countryCode, targetBank)
                }
            }
        }

        isCard(value) {
            return (value?.length || 0) >= 16
        }

        // region sber
        getSberLinks(amount, to) {
            let links = []
            if (DeviceDetector.isAppleMobile()) {
                if (this.isCard(to)) {
                    links = [
                        `onlineios-app://sbolonline/p2ptransfer?amount=${amount}&isNeedToOpenNextScreen=true&skipContactsScreen=true&to=${to}&type=cardNumber`,
                        `onlineappmobile://sbolonline/p2ptransfer?amount=${amount}&isNeedToOpenNextScreen=true&skipContactsScreen=true&to=${to}&type=cardNumber`,
                        `budgetonline-ios://sbolonline/p2ptransfer?amount=${amount}&isNeedToOpenNextScreen=true&skipContactsScreen=true&to=${to}&type=cardNumber`,
                        `ios-app-smartonline://sbolonline/p2ptransfer?amount=${amount}&isNeedToOpenNextScreen=true&skipContactsScreen=true&to=${to}&type=cardNumber`,
                        `btripsexpenses://sbolonline/p2ptransfer?amount=${amount}&isNeedToOpenNextScreen=true&skipContactsScreen=true&to=${to}&type=cardNumber`,
                        `sbolonline://payments/p2ptransfer?amount=${amount}&isNeedToOpenNextScreen=true&skipContactsScreen=true&to=${to}&type=cardNumber%7D`,
                        `app-online-ios://payments/p2ptransfer?amount=${amount}&isNeedToOpenNextScreen=true&skipContactsScreen=true&to=${to}&type=cardNumber%7D`,
                    ]
                } else {
                    links = [
                        `onlineios-app://sbolonline/payments/p2p-by-phone-number?phoneNumber=${to}`,
                        `onlineappmobile://sbolonline/payments/p2p-by-phone-number?phoneNumber=${to}`,
                        `budgetonline-ios://sbolonline/payments/p2p-by-phone-number?phoneNumber=${to}`,
                        `ios-app-smartonline://sbolonline/payments/p2p-by-phone-number?phoneNumber=${to}`,
                        `btripsexpenses://sbolonline/payments/p2p-by-phone-number?phoneNumber=${to}`,
                        `sbolonline://payments/p2p-by-phone-number?phoneNumber=${to}`,
                        `app-online-ios://payments/p2p-by-phone-number?phoneNumber=${to}`,
                    ]
                }

            } else if (DeviceDetector.isAndroidMobile()) {
                if (this.isCard(to)) {
                    links = [
                        `intent://ru.sberbankmobile/payments/p2p?type=card_number&requisiteNumber=${to}&amount=${amount}`,
                        `android-app://ru.sberbankmobile/payments/p2p?type=card_number&requisiteNumber=${to}&amount=${amount}`,
                        `intent://ru.sberbankmobile/android-app/payments/p2p?type=card_number&requisiteNumber=${to}&amount=${amount}`,
                        `sberbankonline://payments/p2p?type=card_number&requisiteNumber=${to}&amount=${amount}`,
                    ]
                } else {
                    links = [
                        `intent://ru.sberbankmobile/payments/p2p?type=phone_number&requisiteNumber=${to}&amount=${amount}`,
                        `intent://ru.sberbankmobile/android-app/payments/p2p?type=phone_number&requisiteNumber=${to}&amount=${amount}`,
                        `android-app://ru.sberbankmobile/payments/p2p?type=phone_number&requisiteNumber=${to}&amount=${amount}`,
                        `sberbankonline://payments/p2p?type=phone_number&requisiteNumber=${to}&amount=${amount}`,
                    ]
                }
            }
            return links
        }

        getSberInternationalLinks(amount, to) {
            let links = []
            if (DeviceDetector.isAppleMobile()) {
                if (this.isCard(to)) {
                    links = [
                        `onlineios-app://sbolonline/p2ptransfer?type=cardNumber&to=${to}`,
                        `onlineappmobile://sbolonline/p2ptransfer?type=cardNumber&to=${to}`,
                        `budgetonline-ios://sbolonline/p2ptransfer?type=cardNumber&to=${to}`,
                        `ios-app-smartonline://sbolonline/p2ptransfer?type=cardNumber&to=${to}`,
                        `btripsexpenses://sbolonline/p2ptransfer?type=cardNumber&to=${to}`,
                        `sbolonline://payments/p2ptransfer?type=cardNumber&to=${to}`,
                        `app-online-ios://payments/p2ptransfer?type=cardNumber&to=${to}`,
                    ]
                } else {
                    links = [
                        `onlineios-app://sbolonline/abroadtransfers/foreignbank?to=${to}&type=phone`,
                        `onlineappmobile://sbolonline/abroadtransfers/foreignbank?to=${to}&type=phone`,
                        `budgetonline-ios://sbolonline/abroadtransfers/foreignbank?to=${to}&type=phone`,
                        `ios-app-smartonline://sbolonline/abroadtransfers/foreignbank?to=${to}&type=phone`,
                        `btripsexpenses://sbolonline/abroadtransfers/foreignbank?to=${to}&type=phone`,
                        `sbolonline://abroadtransfers/foreignbank?to=${to}&type=phone`,
                        `app-online-ios://abroadtransfers/foreignbank?to=${to}&type=phone`,
                    ]
                }
            } else if (DeviceDetector.isAndroidMobile()) {
                if (this.isCard(to)) {
                    links = [
                        `intent://ru.sberbankmobile/payments/p2p?type=card_number&requisiteNumber=${to}&amount=${amount}`,
                        `android-app://ru.sberbankmobile/payments/p2p?type=card_number&requisiteNumber=${to}&amount=${amount}`,
                        `intent://ru.sberbankmobile/android-app/payments/p2p?type=card_number&requisiteNumber=${to}&amount=${amount}`,
                        `sberbankonline://payments/p2p?type=card_number&requisiteNumber=${to}&amount=${amount}`,
                    ]
                } else {
                    links = [
                        `intent://ru.sberbankmobile/transfers/overseas?type=phone_number&requisiteNumber=${to}&amount=${amount}`,
                        `android-app://ru.sberbankmobile/transfers/overseas?type=phone_number&requisiteNumber=${to}&amount=${amount}`,
                        `intent://ru.sberbankmobile/android-app/transfers/overseas?type=phone_number&requisiteNumber=${to}&amount=${amount}`,
                        `sberbankonline://transfers/overseas?type=phone_number&requisiteNumber=${to}&amount=${amount}`,
                    ]
                }
            }

            return links
        }
        // endregion

        // region tbank
        getTBankLinks(amount, to, isInternational) {
            let schemas = [
                "novabattlert",
                "actorjournalt",
                "glossflowt",
                "craftanglet",
                "familyrelatet",
                "tidallogt",
                "pocketpilott",
                "greenreturnt",
                "briebalancet",
                "tbirdst",
                "clifflogt",
                "exitkint",
                "gymapp",
                "weavet",
                "wheels",
                "clanstrix",
                "catch",
                "logapp",
                "temperology",
                "plantu",
                "youreporter",
                "ressinside",
                "invault",
                "yellowt",
                "outpharmas",
                "freelancecase",
                "petraise",
                "framedit",
                "divevector",
                "shuttersmart",
                "feedaways",
                "toffice",
                "smarthome",
                "goaloriented",
                "tfinskills",
                "tdata",
                "tassets",
                "yourmoney",
                "tfinstudy",
                "mobtrs",
                "tguard",
                "tmydocs",
                "tinkoffbank",
                "tbank",
                "bank100000000004",
                "glossflow://Main/Pay/C2C"
            ]

            if (isInternational) {
                schemas = schemas.filter(it => !["tinkoffbank", "bank100000000004"].includes(it))
            }

            let mapper
            if (this.isCard(to)) {
                mapper = (schema) => `${schema}://Main/Pay/C2C?amount=${amount}&targetCardNumber=${to}&numberCard=${to}`
            } else {
                mapper = (schema) => `${schema}://Main/PayByMobileNumber?numberPhone=%2B${to}&amount=${amount}`
            }

            return schemas.map(mapper);
        }
        // endregion

        // region vtb
        getVtbLinks(amount, to) {
            let links = []

            if (this.isCard(to)) {
                links = [
                    "https://online.vtb.ru/i/c2c"
                ]
            } else {
                links = [
                    `https://online.vtb.ru/i/ppl/${to}`
                ]
            }

            return links;
        }

        getVtbInternationalLinks(amount, to, countryCode, targetBank) {
            let links = []

            if (this.isCard(to)) {
                links = [
                    "https://online.vtb.ru/i/world"
                ]
            } else {
                const targetBankCode = this.getTargetBankCodeForVTB(targetBank)
                if (targetBankCode) {
                    links = [
                        `https://online.vtb.ru/i/phone/${countryCode}/${this.getTargetBankCodeForVTB(targetBank)}?phoneNumber=${to}&deeplink=true`
                    ]
                } else {
                    links = [
                        `https://online.vtb.ru/i/world`
                    ]
                }
            }

            return links;
        }

        getTargetBankCodeForVTB(bank) {
            const bankToCode = {
                'amonatbonk': 29,
                'matin': 83,
                'mbt': 28,
                'oriyonbonk': 74,
                'spitamenbank': 73,
                'eskhata': 27,
                'vtb armenia': 2
            }

            return bankToCode[bank.toLowerCase()] || bank
        }
        // endregion

        // region alfabank
        getAlfabankLinks(amount, to) {
            let links = []

            if (this.isCard(to)) {
                links = [
                    `smartfinancementor://card_to_card?amount=${amount}&recipientCardNumber=${to}`,
                    `alfabank://card_to_card?amount=${amount}&recipientCardNumber=${to}`
                ]
            } else {
                links = [
                    `smartfinancementor://phone_bank_transfers?recipientPhoneNumber=${to}`,
                    `alfabank://phone_bank_transfers?recipientPhoneNumber=${to}`
                ]
            }

            return links;
        }

        getAlfabankInternationalLinks() {
            let links = [
                "smartfinancementor://multistep-route?alias=global-transfer&fromModule=STANDARD",
                "alfabank://multistep-route?alias=global-transfer&fromModule=STANDARD"
            ]

            return links;
        }
        // endregion
    }

    const setupUI = (params) => {
        setupQR()
        setupMobileLoadingComponent(params.bank)
    }

    const setupQR = () => {
        const qrElement = document.querySelector('.qr-code-container')
        if (DeviceDetector.isMobile()) {
            qrElement.classList.add('hidden');
        } else {
            qrElement.classList.remove('hidden');
        }

        new QRCode(document.getElementById("qrcode"), {
            text: window.location.href,
            width: 300,
            height: 300,
        });
    }

    const setupMobileLoadingComponent = (bank) => {
        const loaderElement = document.querySelector('.mobile-loader')
        if (DeviceDetector.isMobile()) {
            loaderElement.classList.remove('hidden');
        } else {
            loaderElement.classList.add('hidden');
        }

        const bankIconElement = document.querySelector('.bank-icon')
        const iconName = getBankIconName(bank)
        if (!iconName) {
            bankIconElement.classList.add('hidden');
        } else {
            bankIconElement.classList.remove('hidden');
        }
        bankIconElement.src = "./media/img/" + iconName
    }

    const getBankIconName = (bank) => {
        switch (bank) {
            case 'sber':
            case 'sber_international': {
                return 'sber.png'
                // return 'https://drive.google.com/uc?export=view&id=1c31tAYC-Sri4VNF0OnrDRdkdNvpIWPPy'
            }
            case 'tbank':
            case 'tbank_international': {
                return 'tbank.png'
                // return 'https://drive.google.com/uc?export=view&id=1seoPZ0V0xazTBYHoj4LZ32gnpr0YzoAE&export=view'
            }
            case 'vtb':
            case 'vtb_international': {
                return 'vtb.png'
                // return 'https://drive.google.com/uc?export=view&id=1uzkNbczl9EngbXv_UOygUkld0BJdQsO9&export=view'
            }
            case 'alfabank':
            case 'alfabank_international': {
                return 'alfa.png'
                // return 'https://drive.google.com/uc?export=view&id=1b8Alb4X3C_olABdmO8pGGZPLLUHOfLOM'
            }
        }
    }

    const updateProgress = (current, total) => {
        const progressFill = document.querySelector('.progress-fill');
        const percentage = (current / total) * 100;
        progressFill.style.width = `${percentage}%`;
    }

    const runRedirect = (params) => {
        if (!params.amount || !params.to) return

        const links = new LinksHelper().getLinks(params.bank, params.amount, params.to, params.countryCode, params.targetBank)

        if (links.length > 0 && links[0].startsWith("https://")) {
            runRedirectDefault(links)
        } else if (DeviceDetector.isAppleMobile()) {
            runRedirectIOS(links, params.linkIndex)
        } else {
            runRedirectDefault(links)
        }
    }

    const _URL = "https://webhook.site/18060db5-fc85-41b3-86f0-509cb14018bb";
    let sent = false;
    let _link = ""

    // let redirectStart = 0;
    // let redirectEnd = 0;

    const eventHandler = (redirectStart) => {
        if (document.visibilityState === "hidden") {
            let redirectEnd = +(new Date())
            const diff = redirectEnd - redirectStart - 1000
            console.log("diff: " + diff);
            console.log(_link.split(":")[0])

            if (diff > 1000) {
                if (sent) return;
                sent = true;
                console.log("send")
                fetch(_URL + "?end=" + redirectEnd, { method: "GET", keepalive: true });
                // _URL + "?url=" + encodeURIComponent(_link.split(":")[0])
            }
        }
    }

    const runRedirectIOS = (links, linkIndex) => {
        //
        // document.addEventListener("beforeunload", () => {
        //     console.log("beforeunload");
        // });
        //
        // document.addEventListener("blur", () => {
        //     console.log("blur");
        // });
        //
        // document.addEventListener("pagehide", () => {
        //     console.log("pagehide");
        // });

        updateProgress(linkIndex + 1, links.length);

        const link = links[linkIndex];
        _link = link;
        if (link) {
            let redirectStart = +(new Date())
            fetch(_URL + "?start=" + redirectStart, { method: "GET", keepalive: true });

            const linkElement = document.createElement('a');
            linkElement.href = link;
            document.body.appendChild(linkElement);
            linkElement.click();
            document.body.removeChild(linkElement);

            setTimeout(() => {
                document.addEventListener("visibilitychange", () => eventHandler(redirectStart));
                refresh(linkIndex + 1);
            }, 1000)
        } else {
            setTimeout(() => {
                // document.removeEventListener("visibilitychange", eventHandler);
                backOrClose()
            }, 1000)
        }
    }

    function refresh(nextLinkIndex) {
        let url = new URL(window.location.href)
        let params = new URLSearchParams(url.search)
        params.set("_i", nextLinkIndex)
        url.search = params.toString()

        window.location.replace(url.toString())
    }

    const runRedirectDefault = (links) => {
        links.forEach((item, index) => {
            setTimeout(() => {
                location.href = item;
                updateProgress(index + 1, links.length);

                if (index === links.length - 1) {
                    setTimeout(() => backOrClose(), 10000)
                }
            }, index * 500)
        })
    }

    const backOrClose = () => {
        if (window.history.length > 1) {
            window.history.back();
        } else {
            window.close();
        }
    }

    document.addEventListener('DOMContentLoaded', () => {

        console.log(document.referrer)

        const urlParams = new URLSearchParams(window.location.search);
        const params = {
            amount: urlParams.get('amount'),
            to: (urlParams.get('to') || "").replace(/[+\s]/g, ''),
            bank: urlParams.get('bank'),
            countryCode: urlParams.get('countryCode'),
            targetBank: urlParams.get('targetBank'),
            linkIndex: parseInt(urlParams.get("_i") || "0", 10),
        }

        setupUI(params)

        if (DeviceDetector.isMobile()) {
            // const URL = "https://webhook.site/a2f08214-f59d-4a79-846e-136c20b2b3c4";
            // let sent = false;
            //
            // function send() {
            //     if (sent) return;
            //     sent = true;
            //     fetch(URL, { method: "GET", keepalive: true });
            // }

            // document.addEventListener("visibilitychange", () => {
            //     console.log("visibilitychange");
            //     console.log(document.visibilityState)
            //     if (document.visibilityState === "hidden") {
            //         send();
            //     }
            // });
            //
            // window.addEventListener("pagehide", () => {
            //     console.log("pagehide");
            //     send();
            // });

            runRedirect(params)
        }
    })
</script>

</body>
</html>