<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>App redirect</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" integrity="sha512-CNgIRecGo7nphbeZ04Sc13ka07paqdeTu0WR1IM4kNcpmBAUSHSQX0FslNhTDadL4O5SAGapGt4FodqL8My0mA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
        !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group identify setPersonProperties setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags resetGroups onFeatureFlags addFeatureFlagsHandler onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
        posthog.init('phc_2IP20ZvqI0Qj5F8g0YOAh88iRCa6UbRGyiDaj0lXyu6', {
            api_host: 'https://eu.i.posthog.com',
            defaults: '2025-11-30',
            autocapture: false,
            capture_pageview: false,
            capture_pageleave: false,
            capture_performance: false
        })
    </script>

    <style>
        * {
            box-sizing: border-box;
            padding: 0;
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-optical-sizing: auto;
            font-weight: 400;
            font-style: normal;
            font-variation-settings: "wdth" 100;
        }

        html {
            color: #000000;
        }

        .hidden {
            display: none !important;
        }

        .qr-code-container {
            height: 100vh;
            width: 100vw;
            padding: 30px;
            display: flex;
            gap: 40px;
            align-items: center;
            justify-content: center;
        }

        .qr-code-container .title {
            font-size: 40px;
            font-weight: 600;
            max-width: 500px;
        }

        .qr-code-wrapper {
            padding: 20px;
            background-color: white;
            border-radius: 10px;
        }

        #qrcode {
            width: 300px;
            height: 300px;
        }

        .loading-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            gap: 20px;
            padding: 100px 30px;
        }

        .loading-container img {
            width: 100px;
            height: 100px;
            border-radius: 30px;
            box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px;
        }

        .loading-container .title-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 30px;
            background: #ffffff80;
            border-radius: 30px;
            border: 1px solid #ffffff;
        }

        .loading-container .title {
            font-size: 24px;
            text-align: center;
        }

        /*region progress bar*/
        .progress-container {
            width: 100%;
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .progress-container .title {
            font-size: 14px;
            /*opacity: 0.5;*/
        }

        .progress-container .progress-bar {
            width: 100%;
            height: 30px;
            background-color: #ffffff;
            border: 2px solid #ffffff;
            border-radius: 9999px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-container .progress-fill {
            height: 100%;
            transition: width 200ms linear;
            border-radius: 9999px;
        }
        /*endregion*/

        /*region bank specific styles*/
        .sber-bg-100 {
            background: linear-gradient(to right, rgb(100 238 97 / 10%), rgb(50 184 211 / 10%));
        }
        .sber-bg-500 {
            background: linear-gradient(to right, rgb(100 238 97), rgb(50 184 211));
        }
        .sber-color-900 {
            color: #004723;
        }

        .tbank-bg-100 {
            background: linear-gradient(to right, rgb(255 233 121 / 20%), rgb(254 221 44 / 20%));
        }
        .tbank-bg-500 {
            background: linear-gradient(to right, rgb(255 233 121), rgb(254 221 44));
        }
        .tbank-color-900 {
            color: #8a6f00;
        }

        .vtb-bg-100 {
            background: linear-gradient(to right, rgb(206 182 250 / 10%), rgb(3 72 185 / 10%));
        }
        .vtb-bg-500 {
            background: linear-gradient(to right, rgb(206 182 250), rgb(3 72 185));
        }
        .vtb-color-900 {
            color: #001639;
        }

        .alfabank-bg-100 {
            background: rgb(239 50 36 / 10%);
        }
        .alfabank-bg-500 {
            background: rgb(239 50 36);
        }
        .alfabank-color-900 {
            color: #001639;
        }
        /*endregion*/
    </style>
</head>

<body>

<div class="container">
    <div class="hidden qr-code-container">
        <div class="qr-code-wrapper">
            <div id="qrcode"></div>
        </div>
        <span class="title">Для оплаты отсканируйте QR-код с помощью камеры телефона и перейдите по ссылке</span>
    </div>

    <div class="hidden loading-container">
        <div class="title-container">
            <img class="bank-icon" />
            <span class="title">Открываем приложение</span>
        </div>

        <div class="progress-container">
            <span class="title">Загрузка...</span>
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    const DeviceDetector = {
        isAppleMobile() {
            return /iPhone|iPad|iPod/i.test(navigator.userAgent);
        },

        isAndroidMobile() {
            return /Android/i.test(navigator.userAgent);
        },

        isMobile() {
            return DeviceDetector.isAppleMobile() || DeviceDetector.isAndroidMobile()
        }
    }

    class LinksHelper {
        getLinks(bank, amount, to, countryCode, targetBank) {
            switch (bank) {
                case 'sber': {
                    return this.getSberLinks(amount, to)
                }
                case 'sber_international': {
                    return this.getSberInternationalLinks(amount, to)
                }
                case 'tbank': {
                    return this.getTBankLinks(amount, to, false)
                }
                case 'tbank_international': {
                    return this.getTBankLinks(amount, to, true)
                }
                case 'vtb': {
                    return this.getVtbLinks(amount, to)
                }
                case 'vtb_international': {
                    return this.getVtbInternationalLinks(amount, to, countryCode, targetBank)
                }
                case 'alfabank': {
                    return this.getAlfabankLinks(amount, to)
                }
                case 'alfabank_international': {
                    return this.getAlfabankInternationalLinks(amount, to, countryCode, targetBank)
                }
            }
        }

        isCard(value) {
            return (value?.length || 0) >= 16
        }

        // region sber
        getSberLinks(amount, to) {
            let links = []
            if (DeviceDetector.isAppleMobile()) {
                if (this.isCard(to)) {
                    links = [
                        `onlineios-app://sbolonline/p2ptransfer?amount=${amount}&isNeedToOpenNextScreen=true&skipContactsScreen=true&to=${to}&type=cardNumber`,
                        `onlineappmobile://sbolonline/p2ptransfer?amount=${amount}&isNeedToOpenNextScreen=true&skipContactsScreen=true&to=${to}&type=cardNumber`,
                        `budgetonline-ios://sbolonline/p2ptransfer?amount=${amount}&isNeedToOpenNextScreen=true&skipContactsScreen=true&to=${to}&type=cardNumber`,
                        `ios-app-smartonline://sbolonline/p2ptransfer?amount=${amount}&isNeedToOpenNextScreen=true&skipContactsScreen=true&to=${to}&type=cardNumber`,
                        `btripsexpenses://sbolonline/p2ptransfer?amount=${amount}&isNeedToOpenNextScreen=true&skipContactsScreen=true&to=${to}&type=cardNumber`,
                        `sbolonline://payments/p2ptransfer?amount=${amount}&isNeedToOpenNextScreen=true&skipContactsScreen=true&to=${to}&type=cardNumber%7D`,
                        `app-online-ios://payments/p2ptransfer?amount=${amount}&isNeedToOpenNextScreen=true&skipContactsScreen=true&to=${to}&type=cardNumber%7D`,
                    ]
                } else {
                    links = [
                        `onlineios-app://sbolonline/payments/p2p-by-phone-number?phoneNumber=${to}`,
                        `onlineappmobile://sbolonline/payments/p2p-by-phone-number?phoneNumber=${to}`,
                        `budgetonline-ios://sbolonline/payments/p2p-by-phone-number?phoneNumber=${to}`,
                        `ios-app-smartonline://sbolonline/payments/p2p-by-phone-number?phoneNumber=${to}`,
                        `btripsexpenses://sbolonline/payments/p2p-by-phone-number?phoneNumber=${to}`,
                        `sbolonline://payments/p2p-by-phone-number?phoneNumber=${to}`,
                        `app-online-ios://payments/p2p-by-phone-number?phoneNumber=${to}`,
                    ]
                }

            } else if (DeviceDetector.isAndroidMobile()) {
                if (this.isCard(to)) {
                    links = [
                        `intent://ru.sberbankmobile/payments/p2p?type=card_number&requisiteNumber=${to}&amount=${amount}`,
                        `android-app://ru.sberbankmobile/payments/p2p?type=card_number&requisiteNumber=${to}&amount=${amount}`,
                        `intent://ru.sberbankmobile/android-app/payments/p2p?type=card_number&requisiteNumber=${to}&amount=${amount}`,
                        `sberbankonline://payments/p2p?type=card_number&requisiteNumber=${to}&amount=${amount}`,
                    ]
                } else {
                    links = [
                        `intent://ru.sberbankmobile/payments/p2p?type=phone_number&requisiteNumber=${to}&amount=${amount}`,
                        `intent://ru.sberbankmobile/android-app/payments/p2p?type=phone_number&requisiteNumber=${to}&amount=${amount}`,
                        `android-app://ru.sberbankmobile/payments/p2p?type=phone_number&requisiteNumber=${to}&amount=${amount}`,
                        `sberbankonline://payments/p2p?type=phone_number&requisiteNumber=${to}&amount=${amount}`,
                    ]
                }
            }
            return links
        }

        getSberInternationalLinks(amount, to) {
            let links = []
            if (DeviceDetector.isAppleMobile()) {
                if (this.isCard(to)) {
                    links = [
                        `onlineios-app://sbolonline/p2ptransfer?type=cardNumber&to=${to}`,
                        `onlineappmobile://sbolonline/p2ptransfer?type=cardNumber&to=${to}`,
                        `budgetonline-ios://sbolonline/p2ptransfer?type=cardNumber&to=${to}`,
                        `ios-app-smartonline://sbolonline/p2ptransfer?type=cardNumber&to=${to}`,
                        `btripsexpenses://sbolonline/p2ptransfer?type=cardNumber&to=${to}`,
                        `sbolonline://payments/p2ptransfer?type=cardNumber&to=${to}`,
                        `app-online-ios://payments/p2ptransfer?type=cardNumber&to=${to}`,
                    ]
                } else {
                    links = [
                        `onlineios-app://sbolonline/abroadtransfers/foreignbank?to=${to}&type=phone`,
                        `onlineappmobile://sbolonline/abroadtransfers/foreignbank?to=${to}&type=phone`,
                        `budgetonline-ios://sbolonline/abroadtransfers/foreignbank?to=${to}&type=phone`,
                        `ios-app-smartonline://sbolonline/abroadtransfers/foreignbank?to=${to}&type=phone`,
                        `btripsexpenses://sbolonline/abroadtransfers/foreignbank?to=${to}&type=phone`,
                        `sbolonline://abroadtransfers/foreignbank?to=${to}&type=phone`,
                        `app-online-ios://abroadtransfers/foreignbank?to=${to}&type=phone`,
                    ]
                }
            } else if (DeviceDetector.isAndroidMobile()) {
                if (this.isCard(to)) {
                    links = [
                        `intent://ru.sberbankmobile/payments/p2p?type=card_number&requisiteNumber=${to}&amount=${amount}`,
                        `android-app://ru.sberbankmobile/payments/p2p?type=card_number&requisiteNumber=${to}&amount=${amount}`,
                        `intent://ru.sberbankmobile/android-app/payments/p2p?type=card_number&requisiteNumber=${to}&amount=${amount}`,
                        `sberbankonline://payments/p2p?type=card_number&requisiteNumber=${to}&amount=${amount}`,
                    ]
                } else {
                    links = [
                        `intent://ru.sberbankmobile/transfers/overseas?type=phone_number&requisiteNumber=${to}&amount=${amount}`,
                        `android-app://ru.sberbankmobile/transfers/overseas?type=phone_number&requisiteNumber=${to}&amount=${amount}`,
                        `intent://ru.sberbankmobile/android-app/transfers/overseas?type=phone_number&requisiteNumber=${to}&amount=${amount}`,
                        `sberbankonline://transfers/overseas?type=phone_number&requisiteNumber=${to}&amount=${amount}`,
                    ]
                }
            }

            return links
        }
        // endregion

        // region tbank
        getTBankLinks(amount, to, isInternational) {
            let schemas = []

            let baseSchemas = [
                "tinkoffbank",
                "tbank",
                "bank100000000004",
            ]

            let additionalSchemas = [
                "novabattlert",
                "actorjournalt",
                "glossflowt",
                "craftanglet",
                "familyrelatet",
                "tidallogt",
                "pocketpilott",
                "greenreturnt",
                "briebalancet",
                "tbirdst",
                "clifflogt",
                "exitkint",
                "gymapp",
                "weavet",
                "wheels",
                "clanstrix",
                "catch",
                "logapp",
                "temperology",
                "plantu",
                "youreporter",
                "ressinside",
                "invault",
                "yellowt",
                "outpharmas",
                "freelancecase",
                "petraise",
                "framedit",
                "divevector",
                "shuttersmart",
                "feedaways",
                "toffice",
                "smarthome",
                "goaloriented",
                "tfinskills",
                "tdata",
                "tassets",
                "yourmoney",
                "tfinstudy",
                "mobtrs",
                "tguard",
                "tmydocs",
            ]

            if (DeviceDetector.isAppleMobile()) {
                schemas = [...additionalSchemas, ...baseSchemas]

                if (isInternational) {
                    schemas = schemas.filter(it => !["tinkoffbank", "bank100000000004"].includes(it))
                }
            } else if (DeviceDetector.isAndroidMobile()) {
                schemas = [...baseSchemas, ...additionalSchemas]
            }

            let mapper
            if (this.isCard(to)) {
                mapper = (schema) => `${schema}://Main/Pay/C2C?amount=${amount}&targetCardNumber=${to}&numberCard=${to}`
            } else {
                mapper = (schema) => `${schema}://Main/PayByMobileNumber?numberPhone=%2B${to}&amount=${amount}`
            }

            return schemas.map(mapper);
        }
        // endregion

        // region vtb
        getVtbLinks(amount, to) {
            let links = []

            if (this.isCard(to)) {
                links = [
                    "https://online.vtb.ru/i/c2c"
                ]
            } else {
                links = [
                    `https://online.vtb.ru/i/ppl/${to}`
                ]
            }

            return links;
        }

        getVtbInternationalLinks(amount, to, _countryCode, targetBank) {
            let links = []

            if (this.isCard(to)) {
                links = [
                    "https://online.vtb.ru/i/world"
                ]
            } else {
                const countryCode = targetBank ? this.getCountryCodeForVTB(_countryCode) : null
                const targetBankCode = targetBank ? this.getTargetBankCodeForVTB(targetBank) : null
                if (countryCode && targetBankCode) {
                    links = [
                        `https://online.vtb.ru/i/phone/${countryCode}/${targetBankCode}?phoneNumber=${to}&deeplink=true`
                    ]
                } else {
                    links = [
                        `https://online.vtb.ru/i/world`
                    ]
                }
            }

            return links;
        }

        getCountryCodeForVTB(countryCode) {
            const bankToCode = {
                'uzs': 'UZ'
            }

            return bankToCode[countryCode.toLowerCase()] || countryCode
        }

        getTargetBankCodeForVTB(bank) {
            const bankToCode = {
                'amonatbonk': 29,
                'matin': 83,
                'mbt': 28,
                'oriyonbonk': 74,
                'spitamenbank': 73,
                'eskhata': 27,
                'vtb armenia': 2,
                'poytaxt_bank': 66,
                'octobank': 49,
                'garant_bank': 57,
                'asi_aliance_bank': 50,
                'asia_aliance_bank': 50
            }

            return bankToCode[bank.toLowerCase()] || bank
        }
        // endregion

        // region alfabank
        getAlfabankLinks(amount, to) {
            let links = []

            if (this.isCard(to)) {
                links = [
                    `smartfinancementor://card_to_card?amount=${amount}&recipientCardNumber=${to}`,
                    `alfabank://card_to_card?amount=${amount}&recipientCardNumber=${to}`
                ]
            } else {
                links = [
                    `smartfinancementor://phone_bank_transfers?recipientPhoneNumber=${to}`,
                    `alfabank://phone_bank_transfers?recipientPhoneNumber=${to}`
                ]
            }

            return links;
        }

        getAlfabankInternationalLinks() {
            let links = [
                "smartfinancementor://multistep-route?alias=global-transfer&fromModule=STANDARD",
                "alfabank://multistep-route?alias=global-transfer&fromModule=STANDARD"
            ]

            return links;
        }
        // endregion
    }

    const setupUI = (params) => {
        setupQR()
        setupLoadingUI(params.bank)
    }

    const setupQR = () => {
        const qrElement = document.querySelector('.qr-code-container')
        if (DeviceDetector.isMobile()) {
            qrElement.classList.add('hidden');
        } else {
            qrElement.classList.remove('hidden');

            new QRCode(document.getElementById("qrcode"), {
                text: window.location.href,
                width: 300,
                height: 300,
                correctLevel: QRCode.CorrectLevel.L
            });
        }
    }

    const setupLoadingUI = (bank) => {
        const loaderElement = document.querySelector('.loading-container')
        if (DeviceDetector.isMobile()) {
            loaderElement.classList.remove('hidden');
        } else {
            loaderElement.classList.add('hidden');
        }

        const bankIconElement = document.querySelector('.bank-icon')
        const iconName = getBankIconName(bank)
        bankIconElement.src = "./media/img/" + iconName

        const styleClassPrefix = getBankStyleClassPrefix(bank)
        if (styleClassPrefix) {
            document.querySelector('html').classList.add(styleClassPrefix + '-bg-100')
            document.querySelector('.progress-fill').classList.add(styleClassPrefix + '-bg-500')
            document.querySelector('.progress-container .title').classList.add(styleClassPrefix + '-color-900')
        }
    }

    const getBankIconName = (bank) => {
        switch (bank) {
            case 'sber':
            case 'sber_international': {
                return 'sber.webp'
            }
            case 'tbank':
            case 'tbank_international': {
                return 'tbank.webp'
            }
            case 'vtb':
            case 'vtb_international': {
                return 'vtb.webp'
            }
            case 'alfabank':
            case 'alfabank_international': {
                return 'alfa.webp'
            }
        }
    }

    const getBankStyleClassPrefix = (bank) => {
        switch (bank) {
            case 'sber':
            case 'sber_international': {
                return 'sber'
            }
            case 'tbank':
            case 'tbank_international': {
                return 'tbank'
            }
            case 'vtb':
            case 'vtb_international': {
                return 'vtb'
            }
            case 'alfabank':
            case 'alfabank_international': {
                return 'alfabank'
            }
        }
    }

    const updateProgress = (current, total) => {
        const progressFill = document.querySelector('.progress-fill');

        const prev = Math.max(current - 1, 0);
        const prevPercentage = (prev / total) * 100;
        progressFill.style.width = `${prevPercentage}%`;
        setTimeout(() => {
            const percentage = (current / total) * 100;
            progressFill.style.width = `${percentage}%`;
        })
    }

    const runRedirect = (params) => {
        if (!params.amount || !params.to) return

        const links = new LinksHelper().getLinks(params.bank, params.amount, params.to, params.countryCode, params.targetBank)

        if (links.length > 0 && links[0].startsWith("https://")) {
            runRedirectDefault(links)
        } else if (DeviceDetector.isAppleMobile()) {
            runRedirectIOS(links, params.linkIndex)
        } else {
            runRedirectDefault(links)
        }
    }

    // const _URL = "https://webhook.site/eab639ac-ab9c-450f-8e78-a1d4171e42f7";

    const onVisibilityChange = (redirectStart, visibilityAtStart, link) => {
        if (visibilityAtStart === "hidden") return

        if (document.visibilityState === "hidden") {
            let redirectEnd = +(new Date())
            const diff = redirectEnd - redirectStart - 200

            if (diff > 1000) {
                sendAppOpenEvent(link.split(":")[0])
                incrementRedirectsCount()
            }
        }
    }

    const runRedirectIOS = (links, linkIndex) => {
        updateProgress(linkIndex + 1, links.length);

        const link = links[linkIndex];
        if (link) {
            let redirectStart = +(new Date())

            const linkElement = document.createElement('a');
            linkElement.href = link;
            document.body.appendChild(linkElement);
            linkElement.click();
            document.body.removeChild(linkElement);

            setTimeout(() => {
                let visibilityAtStart = document.visibilityState
                document.addEventListener("visibilitychange", () => onVisibilityChange(redirectStart, visibilityAtStart, link));

                refresh(linkIndex + 1);
            }, 200)
        } else {
            setTimeout(() => {
                onFinish()
            }, 500)
        }
    }

    function refresh(nextLinkIndex) {
        let url = new URL(window.location.href)
        let params = new URLSearchParams(url.search)
        params.set("_i", nextLinkIndex)
        url.search = params.toString()

        window.location.replace(url.toString())
    }

    const runRedirectDefault = (links) => {
        const onVisibilityChange = () => {
            if (document.visibilityState === "hidden") {
                sendAppOpenEvent()
                incrementRedirectsCount()
                document.removeEventListener('visibilitychange', onVisibilityChange);
            }
        }

        document.addEventListener("visibilitychange", onVisibilityChange);

        links.forEach((item, index) => {
            setTimeout(() => {
                location.href = item;
                updateProgress(index + 1, links.length);

                if (index === links.length - 1) {
                    setTimeout(() => {
                        onFinish();
                    }, 10000)
                }
            }, index * 500)
        })
    }

    const onFinish = () => {
        sendOutEventIfNeed()
        backOrClose()
    }

    const backOrClose = () => {
        if (window.history.length > 1) {
            window.history.back();
        } else {
            window.close();
        }
    }

    const sendInitEventIfNeed = () => {
        const initEventWasSent = sessionStorage.getItem("initEventWasSent");
        if (!initEventWasSent) {
            sessionStorage.setItem("initEventWasSent", "true");

            try {
                posthog.capture(
                    'init',
                    { platform: DeviceDetector.isAppleMobile() ? "ios" : "android" },
                    { send_instantly: true }
                )
            } catch(e) {
                console.log(e)
            }
        }
    }

    const sendAppOpenEvent = (schema) => {
        try {
            posthog.capture(
                'app_open',
                { schema, platform: DeviceDetector.isAppleMobile() ? "ios" : "android" },
                { send_instantly: true }
            )
        } catch(e) {
            console.log(e)
        }
    }

    const sendOutEventIfNeed = () => {
        const redirectsCount = getRedirectsCount()
        if (redirectsCount === 0) {
            try {
                posthog.capture(
                    'app_was_not_opened',
                    { platform: DeviceDetector.isAppleMobile() ? "ios" : "android" },
                    { send_instantly: true }
                )
            } catch(e) {
                console.log(e)
            }
        }
        resetRedirectsCount()
    }

    const getRedirectsCount = () => {
        return Number(sessionStorage.getItem("redirectsCount") || "0");
    }

    const incrementRedirectsCount = () => {
        const redirectsCount = getRedirectsCount()
        sessionStorage.setItem("redirectsCount", (redirectsCount + 1).toString())
    }

    const resetRedirectsCount = () => {
        sessionStorage.removeItem("redirectsCount")
    }

    document.addEventListener('DOMContentLoaded', () => {
        sendInitEventIfNeed()

        const urlParams = new URLSearchParams(window.location.search);
        const params = {
            amount: urlParams.get('amount'),
            to: (urlParams.get('to') || "").replace(/[+\s]/g, ''),
            bank: urlParams.get('bank'),
            countryCode: urlParams.get('countryCode'),
            targetBank: urlParams.get('targetBank'),
            linkIndex: parseInt(urlParams.get("_i") || "0", 10),
        }

        setupUI(params)

        if (DeviceDetector.isMobile()) {
            runRedirect(params)
        }
    })
</script>

</body>
</html>